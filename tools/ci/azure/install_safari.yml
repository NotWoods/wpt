parameters:
  channel: preview

# Should match https://web-platform-tests.org/running-tests/safari.html
steps:
- ${{ if eq(parameters.channel, 'preview') }}:
  - script: |
      # Pinned to Safari Technology Preview version 93.
      HOMEBREW_NO_AUTO_UPDATE=1 brew cask install https://raw.githubusercontent.com/Homebrew/homebrew-cask-versions/ecad4c09ff6bd6896d4e87e4fdc54cf8898321ce/Casks/safari-technology-preview.rb
      # Workaround for `safardriver --enable` requiring password:
      # https://github.com/web-platform-tests/wpt/issues/17186#issuecomment-529862851
      mkdir -p ~/Library/WebDriver/
      cp tools/ci/azure/com.apple.SafariTechnologyPreview.plist ~/Library/WebDriver/
      "/Applications/Safari Technology Preview.app/Contents/MacOS/Safari Technology Preview" &
      SAFARI_PID=$!
      sleep 10
      screencapture tmp.png
      base64 tmp.png
      rm tmp.png
      kill $SAFARI_PID
      defaults write com.apple.SafariTechnologyPreview WebKitJavaScriptCanOpenWindowsAutomatically 1
      defaults write com.apple.SafariTechnologyPreview ExperimentalServerTimingEnabled 1
    displayName: 'Install Safari Technology Preview'
- ${{ if eq(parameters.channel, 'stable') }}:
  - script: |
      sudo safaridriver --enable
      defaults write com.apple.Safari WebKitJavaScriptCanOpenWindowsAutomatically 1
    displayName: 'Configure Safari'
